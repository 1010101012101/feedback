// feedback.js
// 2013, Kázmér Rapavi, https://github.com/ivoviz/feedback
// Licensed under the MIT license.
// Version 2.0

(function(a){a.feedback=function(q){function r(){canDraw=!1;a(document).off("mouseenter.feedback mouseleave.feedback",".feedback-helper");a(document).off("mouseup.feedback keyup.feedback");a(document).off("mousedown.feedback",".feedback-setblackout");a(document).off("mousedown.feedback",".feedback-sethighlight");a(document).off("mousedown.feedback click.feedback","#feedback-close");a(document).off("mousedown.feedback","#feedback-canvas");a(document).off("click.feedback","#feedback-highlighter-next");
a(document).off("click.feedback","#feedback-highlighter-back");a(document).off("click.feedback","#feedback-welcome-next");a(document).off("click.feedback","#feedback-overview-back");a(document).off("mouseleave.feedback","body");a(document).off("mouseenter.feedback",".feedback-helper");a(document).off("selectstart.feedback dragstart.feedback");a("#feedback-module").off("click.feedback",".feedback-wizard-close,.feedback-close-btn");a(document).off("click.feedback","#feedback-submit");b.highlightElement&&
(a(document).off("click.feedback","#feedback-canvas"),a(document).off("mousemove.feedback","#feedback-canvas"));a('[data-highlighted="true"]').removeAttr("data-highlight-id").removeAttr("data-highlighted");a("#feedback-module").remove();a(".feedback-btn").show();b.onClose.call(this)}function h(b,f){f="undefined"!==typeof f?f:!0;b.clearRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height());b.fillStyle="rgba(102,102,102,0.5)";b.fillRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height());
a(".feedback-helper").each(function(){"highlight"==a(this).attr("data-type")&&f&&m(b,parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height())});a(".feedback-helper").each(function(){"highlight"==a(this).attr("data-type")&&b.clearRect(parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height())});a(".feedback-helper").each(function(){"blackout"==a(this).attr("data-type")&&(b.fillStyle="rgba(0,0,0,1)",b.fillRect(parseInt(a(this).css("left"),
10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height()))})}function m(a,f,h,n,m){a.strokeStyle=b.strokeStyle;a.shadowColor=b.shadowColor;a.shadowOffsetX=b.shadowOffsetX;a.shadowOffsetY=b.shadowOffsetY;a.shadowBlur=b.shadowBlur;a.lineJoin=b.lineJoin;a.lineWidth=b.lineWidth;a.strokeRect(f,h,n,m);a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;a.lineWidth=1}var b=a.extend({ajaxURL:"",postBrowserInfo:!0,postHTML:!0,postURL:!0,proxy:void 0,letterRendering:!1,initButtonText:"Send feedback",
strokeStyle:"black",shadowColor:"black",shadowOffsetX:1,shadowOffsetY:1,shadowBlur:10,lineJoin:"bevel",lineWidth:3,html2canvasURL:"html2canvas.js",feedbackButton:".feedback-btn",showDescriptionModal:!0,isDraggable:!0,onScreenshotTaken:function(){},tpl:{description:'<div id="feedback-welcome"><div class="feedback-logo">Feedback</div><p>Feedback lets you send us suggestions about our products. We welcome problem reports, feature ideas and general comments.</p><p>Start by writing a brief description:</p><textarea id="feedback-note-tmp"></textarea><p>Next we\'ll let you identify areas of the page related to your description.</p><button id="feedback-welcome-next" class="feedback-next-btn feedback-btn-gray">Next</button><div id="feedback-welcome-error">Please enter a description.</div><div class="feedback-wizard-close"></div></div>',
highlighter:'<div id="feedback-highlighter"><div class="feedback-logo">Feedback</div><p>Click and drag on the page to help us better understand your feedback. You can move this dialog if it\'s in the way.</p><button class="feedback-sethighlight feedback-active"><div class="ico"></div><span>Highlight</span></button><label>Highlight areas relevant to your feedback.</label><button class="feedback-setblackout"><div class="ico"></div><span>Black out</span></button><label class="lower">Black out any personal information.</label><div class="feedback-buttons"><button id="feedback-highlighter-next" class="feedback-next-btn feedback-btn-gray">Next</button><button id="feedback-highlighter-back" class="feedback-back-btn feedback-btn-gray">Back</button></div><div class="feedback-wizard-close"></div></div>',
overview:'<div id="feedback-overview"><div class="feedback-logo">Feedback</div><div id="feedback-overview-description"><div id="feedback-overview-description-text"><h3>Description</h3><h3 class="feedback-additional">Additional info</h3><div id="feedback-additional-none"><span>None</span></div><div id="feedback-browser-info"><span>Browser Info</span></div><div id="feedback-page-info"><span>Page Info</span></div><div id="feedback-page-structure"><span>Page Structure</span></div></div></div><div id="feedback-overview-screenshot"><h3>Screenshot</h3></div><div class="feedback-buttons"><button id="feedback-submit" class="feedback-submit-btn feedback-btn-blue">Submit</button><button id="feedback-overview-back" class="feedback-back-btn feedback-btn-gray">Back</button></div><div id="feedback-overview-error">Please enter a description.</div><div class="feedback-wizard-close"></div></div>',
submitLoading:'<div id="feedback-submit-loading"><div class="feedback-logo">Feedback</div><p>Loading...</p></div>',submitSuccess:'<div id="feedback-submit-success"><div class="feedback-logo">Feedback</div><p>Thank you for your feedback. We value every piece of feedback we receive.</p><p>We cannot respond individually to every one, but we will use your comments as we strive to improve your experience.</p><button class="feedback-close-btn feedback-btn-blue">OK</button><div class="feedback-wizard-close"></div></div>',
submitError:'<div id="feedback-submit-error"><div class="feedback-logo">Feedback</div><p>Sadly an error occured while sending your feedback. Please try again.</p><button class="feedback-close-btn feedback-btn-blue">OK</button><div class="feedback-wizard-close"></div></div>'},onClose:function(){},screenshotStroke:!0,highlightElement:!0,initialBox:!1},q),v=".feedback-btn"==b.feedbackButton,w=!1;window.HTMLCanvasElement&&(v&&a("body").append('<button class="feedback-btn feedback-btn-gray feedback-btn-native">'+
b.initButtonText+"</button>"),a(document).on("click.feedback",b.feedbackButton,function(){v&&a(this).hide();w||a.getScript(b.html2canvasURL,function(){w=!0});var k=!1,f="",q=a(document).height(),n=a(document).width(),t='<div id="feedback-module">';b.initialBox&&(t+=b.tpl.description);t+=b.tpl.highlighter+b.tpl.overview+'<canvas id="feedback-canvas"></canvas><div id="feedback-helpers"></div><input id="feedback-note" name="feedback-note" type="hidden"></div>';a("body").append(t);moduleStyle={position:"absolute",
left:"0px",top:"0px"};canvasAttr={width:n,height:q};a("#feedback-module").css(moduleStyle);a("#feedback-canvas").attr(canvasAttr).css("z-index","30000");b.initialBox||(a("#feedback-highlighter-back").remove(),k=!0,a("#feedback-canvas").css("cursor","crosshair"),a("#feedback-helpers").show(),a("#feedback-welcome").hide(),a("#feedback-highlighter").show());if(b.isDraggable)a("#feedback-highlighter").on("mousedown.feedback",function(b){var d=a(this).addClass("feedback-draggable"),c=d.outerHeight(),e=
d.outerWidth(),h=d.offset().top+c-b.pageY,f=d.offset().left+e-b.pageX;d.css("z-index",4E4).parents().on("mousemove.feedback",function(b){_top=b.pageY+h-c;_left=b.pageX+f-e;_bottom=c-b.pageY;_right=e-b.pageX;0>_left&&(_left=0);0>_top&&(_top=0);_right>a(window).width()&&(_left=a(window).width()-e);_left>a(window).width()-e&&(_left=a(window).width()-e);_bottom>a(document).height()&&(_top=a(document).height()-c);_top>a(document).height()-c&&(_top=a(document).height()-c);a(".feedback-draggable").offset({top:_top,
left:_left}).on("mouseup",function(){a(this).removeClass("feedback-draggable")})});b.preventDefault()}).on("mouseup.feedback",function(){a(this).removeClass("feedback-draggable");a(this).parents().off("mousemove mousedown")});var c=a("#feedback-canvas")[0].getContext("2d");c.fillStyle="rgba(102,102,102,0.5)";c.fillRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height());rect={};drag=!1;highlight=1;post={};b.postBrowserInfo&&(post.browser={},post.browser.appCodeName=navigator.appCodeName,
post.browser.appName=navigator.appName,post.browser.appVersion=navigator.appVersion,post.browser.cookieEnabled=navigator.cookieEnabled,post.browser.onLine=navigator.onLine,post.browser.platform=navigator.platform,post.browser.userAgent=navigator.userAgent,post.browser.plugins=[],a.each(navigator.plugins,function(a){post.browser.plugins.push(navigator.plugins[a].name)}),a("#feedback-browser-info").show());b.postURL&&(post.url=document.URL,a("#feedback-page-info").show());b.postHTML&&(post.html=a("html").html(),
a("#feedback-page-structure").show());b.postBrowserInfo||b.postURL||b.postHTML||a("#feedback-additional-none").show();a(document).on("mousedown.feedback","#feedback-canvas",function(b){k&&(rect.startX=b.pageX-a(this).offset().left,rect.startY=b.pageY-a(this).offset().top,rect.w=0,rect.h=0,drag=!0)});a(document).on("mouseup.feedback",function(){if(k){drag=!1;var b=rect.startY,l=rect.startX,g=rect.w,e=rect.h;dtype="highlight";0!=g&&0!=e&&(0>g&&(l+=g,g*=-1),0>e&&(b+=e,e*=-1),b+e>a(document).height()&&
(e=a(document).height()-b),l+g>a(document).width()&&(g=a(document).width()-l),0==highlight&&(dtype="blackout"),a("#feedback-helpers").append('<div class="feedback-helper" data-type="'+dtype+'" data-time="'+Date.now()+'" style="position:absolute;top:'+b+"px;left:"+l+"px;width:"+g+"px;height:"+e+'px;z-index:30000;"></div>'),h(c),rect.w=0)}});a(document).on("mousemove.feedback",function(b){k&&drag&&(a("#feedback-highlighter").css("cursor","default"),rect.w=b.pageX-a("#feedback-canvas").offset().left-
rect.startX,rect.h=b.pageY-a("#feedback-canvas").offset().top-rect.startY,c.clearRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height()),c.fillStyle="rgba(102,102,102,0.5)",c.fillRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height()),a(".feedback-helper").each(function(){"highlight"==a(this).attr("data-type")&&m(c,parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height())}),1==highlight&&(m(c,rect.startX,rect.startY,rect.w,rect.h),
c.clearRect(rect.startX,rect.startY,rect.w,rect.h)),a(".feedback-helper").each(function(){"highlight"==a(this).attr("data-type")&&c.clearRect(parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height())}),a(".feedback-helper").each(function(){"blackout"==a(this).attr("data-type")&&(c.fillStyle="rgba(0,0,0,1)",c.fillRect(parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height()))}),0==highlight&&(c.fillStyle="rgba(0,0,0,0.5)",
c.fillRect(rect.startX,rect.startY,rect.w,rect.h)))});if(b.highlightElement){var x=[],p=[],u=0;a(document).on("mousemove.feedback click.feedback","#feedback-canvas",function(b){if(k){h(c);p=[];a("#feedback-canvas").css("cursor","crosshair");a("* :not(body,script,iframe,div,section,.feedback-btn,#feedback-module *)").each(function(){"true"!==a(this).attr("data-highlighted")&&b.pageX>a(this).offset().left&&b.pageX<a(this).offset().left+a(this).width()&&b.pageY>a(this).offset().top+parseInt(a(this).css("padding-top"),
10)&&b.pageY<a(this).offset().top+a(this).height()+parseInt(a(this).css("padding-top"),10)&&p.push(a(this))});var d=p[p.length-1];if(d&&!drag){a("#feedback-canvas").css("cursor","pointer");var g=d.offset().left-2,e=d.offset().top-2,f=d.width()+parseInt(d.css("padding-left"),10)+parseInt(d.css("padding-right"),10)+6,d=d.height()+parseInt(d.css("padding-top"),10)+parseInt(d.css("padding-bottom"),10)+6;1==highlight&&(m(c,g,e,f,d),c.clearRect(g,e,f,d),dtype="highlight");a(".feedback-helper").each(function(){"highlight"==
a(this).attr("data-type")&&c.clearRect(parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height())});0==highlight&&(dtype="blackout",c.fillStyle="rgba(0,0,0,0.5)",c.fillRect(g,e,f,d));a(".feedback-helper").each(function(){"blackout"==a(this).attr("data-type")&&(c.fillStyle="rgba(0,0,0,1)",c.fillRect(parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height()))});"click"==b.type&&b.pageX==rect.startX&&b.pageY==rect.startY&&
(a("#feedback-helpers").append('<div class="feedback-helper" data-highlight-id="'+u+'" data-type="'+dtype+'" data-time="'+Date.now()+'" style="position:absolute;top:'+e+"px;left:"+g+"px;width:"+f+"px;height:"+d+'px;z-index:30000;"></div>'),x.push(u),++u,h(c))}}})}a(document).on("mouseleave.feedback","body,#feedback-canvas",function(){h(c)});a(document).on("mouseenter.feedback",".feedback-helper",function(){h(c)});a(document).on("click.feedback","#feedback-welcome-next",function(){0<a("#feedback-note").val().length?
(k=!0,a("#feedback-canvas").css("cursor","crosshair"),a("#feedback-helpers").show(),a("#feedback-welcome").hide(),a("#feedback-highlighter").show()):a("#feedback-welcome-error").show()});a(document).on("mouseenter.feedback mouseleave.feedback",".feedback-helper",function(b){drag||(rect.w=0,rect.h=0,"mouseenter"===b.type?(a(this).css("z-index","30001"),a(this).append('<div class="feedback-helper-inner" style="width:'+(a(this).width()-2)+"px;height:"+(a(this).height()-2)+'px;position:absolute;margin:1px;"></div>'),
a(this).append('<div id="feedback-close"></div>'),a(this).find("#feedback-close").css({top:-1*(a(this).find("#feedback-close").height()/2)+"px",left:a(this).width()-a(this).find("#feedback-close").width()/2+"px"}),"blackout"==a(this).attr("data-type")&&(c.clearRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height()),c.fillStyle="rgba(102,102,102,0.5)",c.fillRect(0,0,a("#feedback-canvas").width(),a("#feedback-canvas").height()),a(".feedback-helper").each(function(){"highlight"==a(this).attr("data-type")&&
m(c,parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height())}),a(".feedback-helper").each(function(){"highlight"==a(this).attr("data-type")&&c.clearRect(parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height())}),c.clearRect(parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height()),c.fillStyle="rgba(0,0,0,0.75)",c.fillRect(parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),
10),a(this).width(),a(this).height()),ignore=a(this).attr("data-time"),a(".feedback-helper").each(function(){if(a(this).attr("data-time")==ignore)return!0;"blackout"==a(this).attr("data-type")&&(c.fillStyle="rgba(0,0,0,1)",c.fillRect(parseInt(a(this).css("left"),10),parseInt(a(this).css("top"),10),a(this).width(),a(this).height()))}))):(a(this).css("z-index","30000"),a(this).children().remove(),"blackout"==a(this).attr("data-type")&&h(c)))});a(document).on("click.feedback","#feedback-close",function(){if(b.highlightElement&&
a(this).parent().attr("data-highlight-id"))var d=a(this).parent().attr("data-highlight-id");a(this).parent().remove();b.highlightElement&&d&&a('[data-highlight-id="'+d+'"]').removeAttr("data-highlighted").removeAttr("data-highlight-id");h(c)});a("#feedback-module").on("click.feedback",".feedback-wizard-close,.feedback-close-btn",function(){r()});a(document).on("keyup.feedback",function(a){27==a.keyCode&&r()});a(document).on("selectstart.feedback dragstart.feedback",function(a){a.preventDefault()});
a(document).on("click.feedback","#feedback-highlighter-back",function(){k=!1;a("#feedback-canvas").css("cursor","default");a("#feedback-helpers").hide();a("#feedback-highlighter").hide();a("#feedback-welcome-error").hide();a("#feedback-welcome").show()});a(document).on("mousedown.feedback",".feedback-sethighlight",function(){highlight=1;a(this).addClass("feedback-active");a(".feedback-setblackout").removeClass("feedback-active")});a(document).on("mousedown.feedback",".feedback-setblackout",function(){highlight=
0;a(this).addClass("feedback-active");a(".feedback-sethighlight").removeClass("feedback-active")});a(document).on("click.feedback","#feedback-highlighter-next",function(){k=!1;a("#feedback-canvas").css("cursor","default");var d=a(document).scrollTop(),l=a(window).height();a("#feedback-helpers").hide();a("#feedback-highlighter").hide();b.screenshotStroke||h(c,!1);html2canvas(a("body"),{onrendered:function(g){b.screenshotStroke||h(c);_canvas=a('<canvas id="feedback-canvas-tmp" width="'+n+'" height="'+
l+'"/>').hide().appendTo("body");_ctx=_canvas.get(0).getContext("2d");_ctx.drawImage(g,0,d,n,l,0,0,n,l);f=_canvas.get(0).toDataURL();a(document).scrollTop(d);post.img=f;b.onScreenshotTaken(post.img);b.showDescriptionModal?(a("#feedback-canvas-tmp").remove(),a("#feedback-overview").show(),a("#feedback-overview-description-text>textarea").remove(),a("#feedback-overview-screenshot>img").remove(),a('<textarea id="feedback-overview-note">'+a("#feedback-note").val()+"</textarea>").insertAfter("#feedback-overview-description-text h3:eq(0)"),
a("#feedback-overview-screenshot").append('<img class="feedback-screenshot" src="'+f+'" />')):(a("#feedback-module").remove(),r(),_canvas.remove())},proxy:b.proxy,letterRendering:b.letterRendering})});a(document).on("click.feedback","#feedback-overview-back",function(b){k=!0;a("#feedback-canvas").css("cursor","crosshair");a("#feedback-overview").hide();a("#feedback-helpers").show();a("#feedback-highlighter").show();a("#feedback-overview-error").hide()});a(document).on("keyup.feedback","#feedback-note-tmp,#feedback-overview-note",
function(b){"feedback-note-tmp"===b.target.id?b=a("#feedback-note-tmp").val():(b=a("#feedback-overview-note").val(),a("#feedback-note-tmp").val(b));a("#feedback-note").val(b)});a(document).on("click.feedback","#feedback-submit",function(){k=!1;if(0<a("#feedback-note").val().length){a("#feedback-submit-success,#feedback-submit-error").remove();a("#feedback-overview").hide();a("#feedback-module").append(b.tpl.submitLoading);post.img=f;post.note=a("#feedback-note").val();var c={feedback:JSON.stringify(post)};
a.ajax({url:b.ajaxURL,dataType:"json",type:"POST",data:c,success:function(){a("#feedback-module").append(b.tpl.submitSuccess)},error:function(){a("#feedback-module").append(b.tpl.submitError)}})}else a("#feedback-overview-error").show()})}))}})(jQuery);
